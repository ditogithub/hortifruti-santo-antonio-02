<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo Hortifruti Santo Ant√¥nio</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --accent:#27ae60;
      --blue:#2d9cdb;
      --danger:#e74c3c;
      --card:#ffffff;
      --muted:#666;
    }
    body { font-family: Arial, sans-serif; margin:0; background:#f7f7f7; color:#222; }
    header {
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      color: white; padding:8px 14px; box-shadow:0 3px 8px rgba(0,0,0,0.08);
      position: sticky; top:0; z-index:1000; display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    #searchContainer{ display:flex; gap:10px; align-items:center; width:100%; max-width:1200px; margin:0 auto; }
    #searchInput{ flex:1; max-width:360px; padding:6px 8px; border-radius:6px; border:1px solid rgba(0,0,0,0.12); }
    #adminLink{ background:rgba(0,0,0,0.2); color:#fff; padding:6px 10px; border-radius:6px; text-decoration:none; font-weight:600; }
    #btnOpenCart{ background:rgba(255,255,255,0.12); color:#fff; padding:6px 10px; border-radius:6px; border:0; cursor:pointer; font-weight:700; }
    .page { padding:18px; max-width:1200px; margin:0 auto; }
    .layout-coluna{ display:flex; flex-direction:column; gap:14px; align-items:center; }
    .card{ background:var(--card); border-radius:10px; padding:14px; width:95%; max-width:1000px; box-shadow:0 6px 18px rgba(0,0,0,0.04); position:relative; }
    .products{ display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }
    .product{ width:180px; background:#fafafa; border:1px solid #eee; border-radius:8px; padding:8px; text-align:center; display:flex; flex-direction:column; gap:8px; }
    .product img{ width:100%; height:110px; object-fit:cover; border-radius:6px; }
    .product .meta{ flex:1; font-size:13px; color:var(--muted); }
    .product .price{ font-weight:700; font-size:14px; }
    .product .controls{ display:flex; gap:6px; align-items:center; justify-content:center; flex-direction:column; }
    .product select, .product input[type="number"]{ width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
    .btn{ border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn-add{ background:var(--accent); color:#fff; width:100%; }
    .cart-items{ display:flex; flex-direction:column; gap:10px; margin-top:8px; max-height:48vh; overflow:auto; padding-right:6px; }
    .cart-item{ display:flex; gap:10px; align-items:center; background:#f8f8f8; padding:8px; border-radius:8px; }
    .cart-item img{ width:64px; height:64px; object-fit:cover; border-radius:6px; }
    .cart-item .info{ flex:1; font-size:14px; }
    .cart-item .info small{ display:block; color:var(--muted); font-size:12px; }
    .remove-btn{ background:var(--danger); color:white; border:0; padding:6px 8px; border-radius:6px; cursor:pointer; }
    .cart-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
    .total{ text-align:right; font-weight:700; font-size:18px; margin-top:8px; }
    .pix-area{ text-align:center; margin-top:12px; }
    .pix-area img{ width:300px; max-width:100%; height:auto; display:block; margin:8px auto; }
    .small{ color:var(--muted); font-size:13px; }

    .client-form { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .client-form input, .client-form textarea { padding:8px; border-radius:6px; border:1px solid #ddd; width:100%; box-sizing:border-box; }
    .client-form .col { flex:1; min-width:200px; }

    .catalog-block {
      position:absolute;
      inset:0;
      background: rgba(255,255,255,0.95);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      border-radius:10px;
      flex-direction:column;
      gap:8px;
      text-align:center;
      z-index:50;
    }
    .catalog-block .msg { font-weight:700; color:var(--danger); }

    /* modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:flex-start; justify-content:center; padding:40px 12px; z-index:2000; }
    .modal{ background:#fff; border-radius:10px; width:100%; max-width:900px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,0.25); max-height:85vh; overflow:auto; }
    .admin-row{ display:flex; align-items:center; gap:12px; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f0f0f0; }
    .admin-row .meta{ flex:1; }
    .admin-controls{ display:flex; gap:8px; }

    @media (max-width:900px){
      .product{ width:48%; }
      header{ padding:10px; flex-direction:column; align-items:stretch; gap:8px; }
      #searchContainer{ max-width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <div id="searchContainer">
      <input id="searchInput" placeholder="üîç Pesquisar produtos..." />
      <a href="#" id="adminLink">Admin</a>
      <button id="btnOpenCart">Carrinho</button>
    </div>
  </header>

  <main class="page">
    <div class="layout-coluna">

      <!-- Produtos / cat√°logo -->
      <div class="card" id="catalogCard">
        <h2 style="text-align:center;margin:0 0 8px 0;">Produtos</h2>
        <div id="productsList" class="products"></div>

        <!-- bloco mostrado quando vendas est√£o bloqueadas -->
        <div id="catalogBlocked" class="catalog-block" style="display:none;">
          <div class="msg">‚ö†Ô∏è As vendas est√£o temporariamente bloqueadas. Volte mais tarde.</div>
          <div class="small">No painel admin voc√™ pode alterar o status para liberar as vendas.</div>
        </div>
      </div>

      <!-- Carrinho -->
      <div class="card" id="cartCard" style="display:none;">
        <h2 style="text-align:center;margin:0 0 8px 0;">Or√ßamento</h2>

        <!-- Dados do cliente -->
        <div class="client-form">
          <div class="col">
            <input id="clientName" placeholder="Nome">
          </div>
          <div class="col">
            <input id="clientPhone" placeholder="Telefone (ex: (81) 9xxxx-xxxx)">
          </div>
          <div class="col" style="flex-basis:100%;">
            <textarea id="clientAddress" rows="2" placeholder="Endere√ßo (rua, n¬∫, bairro)"></textarea>
          </div>
          <div class="col" style="flex-basis:100%; display:flex; gap:8px; align-items:center;">
            <input id="clientLocation" placeholder="Localiza√ß√£o (link do Maps)" style="flex:1;">
            <button class="btn" style="background:var(--blue); color:#fff;" id="btnUseLocation">üìç Usar minha localiza√ß√£o</button>
          </div>
        </div>

        <div id="cartItems" class="cart-items">
          <div class="small">Nenhum item ainda.</div>
        </div>

        <div class="total" id="cartTotal">Total: R$ 0,00</div>

        <div class="cart-actions">
          <button class="btn" style="background:#e74c3c;color:#fff" onclick="limparCarrinho()">üóëÔ∏è Limpar carrinho</button>
          <button class="btn" style="background:#25d366;color:#fff" onclick="enviarWhats()">üì≤ Enviar pelo WhatsApp</button>
          <button class="btn" style="background:var(--blue);color:#fff" onclick="continuarComprando()">‚û°Ô∏è Continuar comprando</button>
        </div>

        <div class="pix-area" id="pixArea">
          <h3 style="margin:12px 0 6px 0;">Pagamento PIX</h3>
          <div class="small">Chave PIX (telefone): <b id="pixKeyDisplay">--</b></div>
          <!-- QR (o atributo onerror far√° fallback se necess√°rio) -->
          <img id="pixQr" src="" alt="QR PIX" style="display:none;" width="300" height="300" onerror="handleQrError()">
          <div id="pixCopy" style="margin-top:8px; display:none;">
            <label style="font-size:13px">C√≥digo copia&cola:</label>
            <textarea id="pixPayload" readonly rows="3" style="width:100%; margin-top:6px; padding:6px; border-radius:6px; border:1px solid #ddd;"></textarea>
          </div>
        </div>

      </div>

    </div>
  </main>

  <script>
    // =========================
    // FIREBASE (compat) CONFIG
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDjzWfLJ5NbmD2MlfycN0FJc3UnvyeCX9s",
      authDomain: "catalogo-hortifruti.firebaseapp.com",
      projectId: "catalogo-hortifruti",
      storageBucket: "catalogo-hortifruti.firebasestorage.app",
      messagingSenderId: "38002725935",
      appId: "1:38002725935:web:91b94df5051a6317f2a2da"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

  // =========================
// LOJISTA / PIX / WHATSAPP (PIX corrigido)
// =========================
const rawPixPhone = '+5581982434784'; // sua chave PIX
function normalizePhone(raw){
  const digits = String(raw).replace(/\D/g,'');
  return digits.startsWith('55') ? digits : '55'+digits;
}
const pixKeyPhone = normalizePhone(rawPixPhone);
document.getElementById('pixKeyDisplay').innerText = rawPixPhone;

// vendedor (n√∫mero que recebe pedidos)
const sellerRaw = '+5581982434784';
const sellerPhone = normalizePhone(sellerRaw);

// merchant details
const merchantName = 'CASSIANA DOS S FERREIRA';
const merchantCity = 'IGARASSU';

// fun√ß√£o para gerar payload PIX compat√≠vel com QR
function buildPixPayload(key, merchantName, merchantCity, amount){
  const amt = amount && Number(amount) > 0 ? Number(amount).toFixed(2) : '';
  const mName = merchantName.toUpperCase().slice(0,25);
  const mCity = merchantCity.toUpperCase().slice(0,15);
  const payload = `00020126580014BR.GOV.BCB.PIX0114${key}0208Compra12352040000530398654${amt}5802BR59${mName.length.toString().padStart(2,'0')}${mName}60${mCity.length.toString().padStart(2,'0')}${mCity}6304`;
  return payload;
}

// fun√ß√£o para atualizar QR e copia&cola
function updatePixQr(amount){
  const payload = buildPixPayload(pixKeyPhone, merchantName, merchantCity, amount);
  const pixImg = document.getElementById('pixQr');
  pixImg.src = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(payload)}&size=300x300`;
  pixImg.style.display='block';
  const payloadEl = document.getElementById('pixPayload');
  payloadEl.value = payload;
  document.getElementById('pixCopy').style.display='block';
}


    // Firestore config path (conforme voc√™ pediu)
    const CONFIG_COLLECTION = 'config';
    const CONFIG_DOC_ID = 'libera√ß√£o_de_vendas'; // <--- documento que guarda status

    // =========================
    // CART (localStorage)
    // =========================
    let cart = JSON.parse(localStorage.getItem('cart_v2') || '[]');
    function saveCart(){ localStorage.setItem('cart_v2', JSON.stringify(cart)); }

    // =========================
    // UTIL
    // =========================
    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
    function formatBRL(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency', currency:'BRL'}); }
    function calcTotal(){ return cart.reduce((s,it)=> s + (Number(it.unitPrice||0) * Number(it.qty||0)), 0); }

    // =========================
    // SALES STATUS HELPERS
    // =========================
    async function getSalesStatus(){
      try {
        const ref = db.collection(CONFIG_COLLECTION).doc(CONFIG_DOC_ID);
        const snap = await ref.get();
        if(!snap.exists) return 'liberado';
        const data = snap.data();
        return data && data.status === 'bloqueado' ? 'bloqueado' : 'liberado';
      } catch(e){
        console.error('Erro lendo status vendas:', e);
        return 'liberado';
      }
    }

    async function setSalesStatus(status){
      await db.collection(CONFIG_COLLECTION).doc(CONFIG_DOC_ID).set({ status }, { merge: true });
      return status;
    }

    // =========================
    // RENDER PRODUTOS
    // =========================
    async function carregarProdutos(){
      const status = await getSalesStatus();
      const snap = await db.collection('produtos').get();
      const container = document.getElementById('productsList');
      container.innerHTML = '';

      snap.forEach(doc => {
        const p = doc.data();
        p._id = doc.id;
        // show product in catalog regardless of status, but control add button enabling
        const priceUnit = (p.priceUnit != null) ? Number(p.priceUnit) : null;
        const priceKg = (p.priceKg != null) ? Number(p.priceKg) : null;
        const precoTexto = priceUnit ?? priceKg ?? 0;

        const card = document.createElement('div');
        card.className = 'product';
        card.innerHTML = `
          <img src="${escapeHtml(p.img || 'https://via.placeholder.com/400x300?text=Sem+imagem')}">
          <div class="meta">
            <strong>${escapeHtml(p.name || 'Produto')}</strong>
            <div style="margin-top:6px;font-size:13px;color:var(--muted)">${escapeHtml(p.desc || '')}</div>
          </div>
          <div class="price">${formatBRL(precoTexto)}</div>
          <div class="controls">
            <select id="mode_${p._id}">
              ${priceUnit != null ? '<option value="unit">Unid</option>' : ''}
              ${priceKg != null ? '<option value="kg">Kg</option>' : ''}
            </select>
            <input id="qty_${p._id}" type="number" min="0.01" step="0.01" value="1" style="box-sizing:border-box;">
            <button class="btn btn-add" id="add_${p._id}">‚ûï Adicionar</button>
          </div>
        `;
        container.appendChild(card);

        const sel = card.querySelector(`#mode_${p._id}`);
        const addBtn = card.querySelector(`#add_${p._id}`);
        if(!sel || sel.options.length === 0){
          addBtn.disabled = true;
          addBtn.textContent = 'Sem pre√ßo';
          addBtn.style.opacity = 0.6;
        }

        // if sales blocked => disable add buttons
        if(status === 'bloqueado'){
          addBtn.disabled = true;
          addBtn.textContent = 'Vendas Bloqueadas';
          addBtn.style.opacity = 0.6;
        }

        addBtn.addEventListener('click', ()=>{
          if(addBtn.disabled) { alert('No momento as vendas est√£o bloqueadas.'); return; }
          const selectedMode = sel ? sel.value : (priceUnit!=null ? 'unit' : 'kg');
          const qty = Number(card.querySelector(`#qty_${p._id}`).value) || 1;
          const unitPrice = selectedMode === 'kg' ? priceKg : priceUnit;
          if(unitPrice == null){ alert('Pre√ßo inv√°lido.'); return; }
          const item = {
            id: p._id,
            name: p.name || 'Produto',
            img: p.img || 'https://via.placeholder.com/400x300?text=Sem+imagem',
            mode: selectedMode,
            qty,
            unitPrice: Number(unitPrice)
          };
          addToCart(item);
        });
      });

      // show/hide catalog blocked overlay
      const blockedEl = document.getElementById('catalogBlocked');
      blockedEl.style.display = (status === 'bloqueado') ? '' : 'none';
    }

    // =========================
    // CART FUNCTIONS
    // =========================
    function addToCart(item){
      const exist = cart.find(i=> i.id===item.id && i.mode===item.mode && i.unitPrice === item.unitPrice);
      if(exist){ exist.qty = Number(exist.qty) + Number(item.qty); }
      else { cart.push(item); }
      saveCart();
      renderCart();
      abrirCarrinho();
    }
    function removeFromCart(index){ cart.splice(index,1); saveCart(); renderCart(); }
    function limparCarrinho(){ if(!confirm('Limpar todo o carrinho?')) return; cart = []; saveCart(); renderCart(); }

    function renderCart(){
      const list = document.getElementById('cartItems');
      list.innerHTML = '';
      if(cart.length === 0){
        list.innerHTML = '<div class="small">Nenhum item ainda.</div>';
        document.getElementById('cartTotal').innerText = 'Total: R$ 0,00';
        document.getElementById('pixQr').style.display = 'none';
        document.getElementById('pixCopy').style.display = 'none';
        return;
      }
      cart.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'cart-item';
        const subtotal = Number(it.unitPrice) * Number(it.qty);
        row.innerHTML = `
          <img src="${escapeHtml(it.img)}" alt="${escapeHtml(it.name)}">
          <div class="info">
            <strong>${escapeHtml(it.name)}</strong>
            <small>${it.qty} ${it.mode === 'kg' ? 'kg' : 'un.'} √ó ${formatBRL(it.unitPrice)} ‚Äî <b>${formatBRL(subtotal)}</b></small>
          </div>
          <button class="remove-btn" data-idx="${idx}">Remover</button>
        `;
        list.appendChild(row);
      });
      document.querySelectorAll('.remove-btn').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const i = Number(e.currentTarget.dataset.idx);
          removeFromCart(i);
        });
      });
      const total = calcTotal();
      document.getElementById('cartTotal').innerText = `Total: ${formatBRL(total)}`;

      // gerar PIX EMV + QR (com VALOR do carrinho)
      const payload = buildPixEMV(pixKeyPhone, merchantName, merchantCity, total);
      // preenche o textarea copy&cola
      const payloadEl = document.getElementById('pixPayload');
      if(payloadEl) payloadEl.value = payload;

      // tenta gerar QR pelo Google Charts; se falhar, onerror chama fallback
      const googleQr = 'https://chart.googleapis.com/chart?chs=400x400&cht=qr&chl=' + encodeURIComponent(payload);
      const pixImg = document.getElementById('pixQr');
      pixImg.src = googleQr;
      pixImg.style.display = 'block';
      document.getElementById('pixCopy').style.display = 'block';
    }

    // fallback handler caso a imagem QR falhe (ex: google blocked)
    function handleQrError(){
      try {
        const payload = document.getElementById('pixPayload').value || '';
        if(!payload) return;
        // fallback: qrserver
        const fallback = 'https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=' + encodeURIComponent(payload);
        const pixImg = document.getElementById('pixQr');
        // remove previous onerror to avoid loop
        pixImg.onerror = null;
        pixImg.src = fallback;
        pixImg.style.display = 'block';
      } catch(e){
        console.error('Erro ao gerar QR fallback:', e);
      }
    }

    // =========================
    // PIX EMV builder (CRC16 XModem)
    // =========================
    function buildField(id, value){
      const v = value ?? '';
      return (id.toString().padStart(2,'0')) + String(v.length).padStart(2,'0') + v;
    }
    function crc16(input){
      const buf = new TextEncoder().encode(input);
      let crc = 0xFFFF;
      for(let i=0;i<buf.length;i++){
        crc ^= (buf[i] & 0xFF) << 8;
        for(let j=0;j<8;j++){
          crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) & 0xFFFF : (crc << 1) & 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4,'0');
    }
    function buildPixEMV(key, merchantName, merchantCity, amount){
      const mName = String(merchantName).slice(0,25).toUpperCase();
      const mCity = String(merchantCity).slice(0,15).toUpperCase();
      const gui = buildField(0,'BR.GOV.BCB.PIX');
      const keyFld = buildField(1, key);
      const sub = gui + keyFld;
      const merchantAccountInfo = '26' + String(sub.length).padStart(2,'0') + sub;
      let payload = '';
      payload += '00' + '02' + '01';
      payload += '01' + '02' + '12';
      payload += merchantAccountInfo;
      payload += '52' + '04' + '0000';
      payload += '53' + '03' + '986';
      if(amount && Number(amount) > 0){
        const amt = Number(amount).toFixed(2);
        payload += '54' + String(amt.length).padStart(2,'0') + amt;
      }
      payload += '58' + '02' + 'BR';
      payload += '59' + String(mName.length).padStart(2,'0') + mName;
      payload += '60' + String(mCity.length).padStart(2,'0') + mCity;
      const txid = '***';
      const add = '05' + String(txid.length).padStart(2,'0') + txid;
      payload += '62' + String(add.length).padStart(2,'0') + add;
      const crcInput = payload + '63' + '04';
      const crc = crc16(crcInput);
      payload = crcInput + crc;
      return payload;
    }

    // =========================
    // WHATSAPP SEND: inclui cliente e localiza√ß√£o (se houver)
    // =========================
    function enviarWhats(){
      if(cart.length === 0){ alert('Carrinho vazio.'); return; }
      const clientName = (document.getElementById('clientName').value || 'N√£o informado').trim();
      const clientPhone = (document.getElementById('clientPhone').value || 'N√£o informado').trim();
      const clientAddress = (document.getElementById('clientAddress').value || 'N√£o informado').trim();
      const clientLocation = (document.getElementById('clientLocation').value || '').trim();

      // montar mensagem com formata√ß√£o parecida com solicitado
      let mensagem = `üõí *Or√ßamento Hortifruti Santo Ant√¥nio*%0A%0A`;
      mensagem += `üë§ *Nome:* ${encodeURIComponent(clientName)}%0A`;
      mensagem += `üìû *Telefone:* ${encodeURIComponent(clientPhone)}%0A`;
      mensagem += `üè† *Endere√ßo:* ${encodeURIComponent(clientAddress)}%0A`;
      if(clientLocation) mensagem += `üìç *Localiza√ß√£o:* ${encodeURIComponent(clientLocation)}%0A`;
      mensagem += `%0A‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ-%0Aüçé Produtos selecionados:%0A`;

      cart.forEach((it, idx) => {
        const subtotal = Number(it.unitPrice) * Number(it.qty);
        const modoLabel = it.mode === 'kg' ? 'kg' : 'un.';
        mensagem += `${idx+1}Ô∏è‚É£ *${encodeURIComponent(it.name)}*%0A`;
        mensagem += `   - Pre√ßo: ${encodeURIComponent(formatBRL(it.unitPrice))} (${modoLabel})%0A`;
        mensagem += `   - Quantidade: ${encodeURIComponent(String(it.qty))}%0A`;
      });

      mensagem += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ-%0Aüí∞ *Total:* ${encodeURIComponent(formatBRL(calcTotal()))}%0A%0A`;
      // payload PIX (copia e cola)
      const payload = document.getElementById('pixPayload').value || buildPixEMV(pixKeyPhone, merchantName, merchantCity, calcTotal());
      mensagem += `üìå Fa√ßa seu pagamento via PIX (copia e cola):%0A${encodeURIComponent(payload)}%0A%0A`;
      mensagem += `Muito obrigado pela prefer√™ncia! üòÑ`;

      const url = `https://wa.me/${sellerPhone}?text=${mensagem}`;
      window.open(url, '_blank');
    }

    // =========================
    // LOCATION helper
    // =========================
    document.getElementById('btnUseLocation').addEventListener('click', ()=>{
      if(!navigator.geolocation){
        alert('Geolocaliza√ß√£o n√£o suportada no seu navegador.');
        return;
      }
      const btn = document.getElementById('btnUseLocation');
      btn.textContent = '‚åõ Obtendo...';
      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const link = `https://maps.google.com/?q=${lat},${lon}`;
        document.getElementById('clientLocation').value = link;
        btn.textContent = 'üìç Usar minha localiza√ß√£o';
      }, (err)=>{
        alert('N√£o foi poss√≠vel obter localiza√ß√£o: ' + err.message);
        btn.textContent = 'üìç Usar minha localiza√ß√£o';
      }, { timeout: 15000 });
    });

    // =========================
    // UI: abrir/fechar carrinho
    // =========================
    const btnOpenCart = document.getElementById('btnOpenCart');
    const cartCard = document.getElementById('cartCard');
    const catalogCard = document.getElementById('catalogCard');
    function abrirCarrinho(){ catalogCard.style.display = 'none'; cartCard.style.display = ''; window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function continuarComprando(){ cartCard.style.display = 'none'; catalogCard.style.display = ''; window.scrollTo({ top: catalogCard.offsetTop, behavior: 'smooth' }); }
    btnOpenCart.addEventListener('click', ()=> abrirCarrinho());

    // =========================
    // SEARCH
    // =========================
    document.getElementById('searchInput').addEventListener('input', async (e)=>{
      const term = e.target.value.trim().toLowerCase();
      await carregarProdutos();
      if(!term) return;
      document.querySelectorAll('#productsList .product').forEach(card=>{
        const txt = card.textContent.toLowerCase();
        card.style.display = txt.includes(term) ? '' : 'none';
      });
    });

    // =========================
    // ADMIN (modal) + vendas toggle
    // =========================
    const adminLink = document.getElementById('adminLink');
    adminLink.addEventListener('click', openAdmin);
    async function openAdmin(e){
      e.preventDefault();
      const senha = prompt('Senha admin:');
      if(senha !== '1234') return alert('Senha incorreta!');
      await showAdminModal();
    }

    async function showAdminModal(){
      // read current sales status first
      const status = await getSalesStatus();

      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      backdrop.innerHTML = `
        <div class="modal">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
            <h2 style="margin:0">Painel Admin</h2>
            <div>
              <button id="closeAdmin" class="btn" style="background:var(--blue); color:white; margin-right:8px;">Fechar</button>
              <button id="btnAdd" class="btn" style="background:var(--accent); color:white;">‚ûï Adicionar</button>
            </div>
          </div>

          <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
            <div style="font-weight:700;">Status de vendas atual:</div>
            <div id="statusText" style="font-weight:700; color:${status === 'liberado' ? 'green' : 'red'}; margin-right:auto;">
              ${status === 'liberado' ? 'Vendas Liberadas' : 'Vendas Bloqueadas'}
            </div>

            <button id="btnToggleSales" class="btn" style="background:${status === 'liberado' ? '#e74c3c' : 'green'}; color:white;">
              ${status === 'liberado' ? 'Bloquear vendas' : 'Liberar vendas'}
            </button>
          </div>

          <div style="margin-bottom:12px;">
            <strong>Produtos</strong>
            <div id="adminList" style="margin-top:8px;"></div>
          </div>
        </div>
      `;
      document.body.appendChild(backdrop);

      // close handler (just remove modal, keep page intact)
      document.getElementById('closeAdmin').addEventListener('click', ()=>{
        backdrop.remove();
        // update catalog in background (in case admin changed something elsewhere)
        carregarProdutos();
      });

      // add product
      document.getElementById('btnAdd').addEventListener('click', async ()=>{
        await criarProduto();
        await carregarAdminList(); // refresh list inside modal
        await carregarProdutos();  // in case a product was added
      });

      // toggle sales handler (single button)
      document.getElementById('btnToggleSales').addEventListener('click', async ()=>{
        // read current displayed text to infer current state
        const stEl = document.getElementById('statusText');
        const current = stEl.textContent.includes('Liberad') ? 'liberado' : 'bloqueado';
        const novo = current === 'liberado' ? 'bloqueado' : 'liberado';
        await setSalesStatus(novo);
        // update UI inside modal (without recreating modal)
        stEl.textContent = (novo === 'liberado') ? 'Vendas Liberadas' : 'Vendas Bloqueadas';
        stEl.style.color = (novo === 'liberado') ? 'green' : 'red';
        const btn = document.getElementById('btnToggleSales');
        btn.textContent = (novo === 'liberado') ? 'Bloquear vendas' : 'Liberar vendas';
        btn.style.background = (novo === 'liberado') ? '#e74c3c' : 'green';
        // update catalog overlay & buttons immediately
        await carregarProdutos();
        // refresh admin product list too
        await carregarAdminList();
        alert(`Vendas ${novo === 'liberado' ? 'liberadas' : 'bloqueadas'}.`);
      });

      // finally populate admin list inside modal
      await carregarAdminList();
    }

    async function carregarAdminList(){
      const listEl = document.getElementById('adminList');
      if(!listEl) return;
      listEl.innerHTML = '<div class="small">Carregando...</div>';
      const snap = await db.collection('produtos').get();
      listEl.innerHTML = '';
      snap.forEach(doc => {
        const p = doc.data();
        const id = doc.id;
        const priceText = (p.priceUnit ?? p.priceKg ?? 0);
        const row = document.createElement('div');
        row.className = 'admin-row';
        row.innerHTML = `
          <div class="meta">
            <strong>${escapeHtml(p.name || 'Produto')}</strong><br>
            <small>${escapeHtml(p.desc || '')}</small><br>
            <small>${formatBRL(priceText)}</small>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="text-align:center; font-weight:700; color:${p.ativo ? 'green' : 'red'};">
              ${p.ativo ? 'Ativo' : 'Desativado'}
            </div>
            <div class="admin-controls">
              <button class="btnToggle btn" data-id="${id}" data-ativo="${p.ativo ? '1' : '0'}">
                ${p.ativo ? 'Desativar' : 'Ativar'}
              </button>
              <button class="btnEdit btn" data-id="${id}">‚úèÔ∏è Editar</button>
              <button class="btnDel btn" data-id="${id}" style="background:transparent; color:red;">üóëÔ∏è Excluir</button>
            </div>
          </div>
        `;
        listEl.appendChild(row);
      });

      // attach events after list exists
      listEl.querySelectorAll('.btnToggle').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.dataset.id;
          const atual = b.dataset.ativo === '1';
          await db.collection('produtos').doc(id).update({ ativo: !atual });
          await carregarAdminList();
        };
      });
      listEl.querySelectorAll('.btnDel').forEach(b=>{
        b.onclick = async ()=>{
          if(!confirm('Remover este produto?')) return;
          await db.collection('produtos').doc(b.dataset.id).delete();
          await carregarAdminList();
        };
      });
      listEl.querySelectorAll('.btnEdit').forEach(b=>{
        b.onclick = async ()=>{
          await editarProduto(b.dataset.id);
          await carregarAdminList();
        };
      });
    }

    // criar / editar produto
    async function criarProduto(){
      const name = prompt('Nome do produto:');
      if(!name) return;
      const desc = prompt('Descri√ß√£o:') || '';
      const priceUnit = prompt('Pre√ßo por unidade (deixe vazio se n√£o tiver):') || '';
      const priceKg = prompt('Pre√ßo por kg (deixe vazio se n√£o tiver):') || '';
      const img = prompt('URL da imagem (opcional):') || '';
      await db.collection('produtos').add({
        name,
        desc,
        priceUnit: priceUnit !== '' ? Number(priceUnit.replace(',','.')) : null,
        priceKg: priceKg !== '' ? Number(priceKg.replace(',','.')) : null,
        img,
        ativo: true
      });
    }
    async function editarProduto(id){
      const ref = db.collection('produtos').doc(id);
      const snap = await ref.get();
      const p = snap.data() || {};
      const name = prompt('Nome:', p.name || '') || p.name;
      const desc = prompt('Descri√ß√£o:', p.desc || '') || p.desc;
      const priceUnit = prompt('Pre√ßo por unidade:', p.priceUnit ?? '') ?? p.priceUnit;
      const priceKg = prompt('Pre√ßo por kg:', p.priceKg ?? '') ?? p.priceKg;
      const img = prompt('URL da imagem:', p.img ?? '') ?? p.img;
      await ref.update({
        name,
        desc,
        priceUnit: priceUnit !== '' ? Number(priceUnit) : null,
        priceKg: priceKg !== '' ? Number(priceKg) : null,
        img
      });
    }

    // =========================
    // INIT
    // =========================
    (function init(){
      cart = JSON.parse(localStorage.getItem('cart_v2') || '[]');
      renderCart();
      carregarProdutos();
      document.getElementById('pixKeyDisplay').innerText = pixKeyDisplayText;
    })();

    // expose common functions (debug)
    window.addToCart = addToCart;
    window.removeFromCart = removeFromCart;
    window.limparCarrinho = limparCarrinho;
    window.abrirCarrinho = abrirCarrinho;
    window.continuarComprando = continuarComprando;
    window.enviarWhats = enviarWhats;
  </script>
</body>
</html>
